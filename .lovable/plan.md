
# Анализ DentaClinic CRM и план улучшений для продакшена

## Общее состояние проекта

Проект представляет собой полноценную CRM-систему для стоматологических клиник с основными модулями: управление пациентами, расписание, планы лечения, финансы, документы, склад и аналитика.

---

## КРИТИЧЕСКИЕ ПРОБЛЕМЫ БЕЗОПАСНОСТИ (требуют немедленного исправления)

### 1. Уязвимости RLS-политик
Сканер безопасности обнаружил 7 критических проблем:

| Таблица | Риск | Рекомендация |
|---------|------|--------------|
| `profiles` | Персональные данные сотрудников доступны без аутентификации | Добавить политику `auth.uid() IS NOT NULL` |
| `appointments` | Медицинские данные (диагнозы, жалобы) могут быть доступны публично | Добавить политику аутентификации |
| `clinics` | Контактные данные клиник могут быть собраны конкурентами | Ограничить доступ |
| `payments` | Финансовые записи пациентов уязвимы | Требовать аутентификацию |
| `performed_works` | Детали лечения могут быть просмотрены | Защитить политикой |
| `user_roles` | Роли пользователей могут быть обнаружены | Ограничить видимость |

### 2. Защита от утёкших паролей
Защита паролей через HaveIBeenPwned **отключена**. Рекомендуется включить для предотвращения использования скомпрометированных паролей.

---

## ФУНКЦИОНАЛЬНЫЕ УЛУЧШЕНИЯ

### Модуль 1: Аналитика (Приоритет: Высокий)

**Текущее состояние:** Страница Analytics использует **статические демо-данные**, а не реальные данные из БД.

**Необходимо реализовать:**
- Загрузка реальных данных выручки по дням/неделям/месяцам
- Расчёт реальной конверсии (записавшиеся -> пришли -> оплатили)
- Статистика по популярным услугам из `performed_works`
- Расчёт загрузки врачей из `appointments`
- Фильтрация по периодам

### Модуль 2: Склад/Инвентарь (Приоритет: Высокий)

**Текущее состояние:** Базовый CRUD без связи с услугами.

**Необходимо реализовать:**
- Автоматическое списание материалов при выполнении услуг (связь с `material_usage`)
- История движения материалов (приход/расход)
- Оповещения о низком остатке (push/email)
- Связь материалов с конкретными услугами
- Отчёт по расходу материалов

### Модуль 3: Уведомления пациентов (Приоритет: Высокий)

**Текущее состояние:** Edge function готова, но:
- Нет секрета `ESKIZ_EMAIL` и `ESKIZ_PASSWORD` для SMS
- Нет секрета `TELEGRAM_BOT_TOKEN` для Telegram
- Telegram интеграция требует доработки (нужен chat_id пациента)

**Необходимо реализовать:**
- Настройка интеграции с SMS-провайдером
- Автоматические напоминания о приёмах (за 24ч, за 2ч)
- Напоминания о запланированных этапах лечения
- Поздравления с днём рождения
- История всех уведомлений в карточке пациента

### Модуль 4: Онлайн-запись пациентов (Приоритет: Средний)

**Текущее состояние:** Отсутствует.

**Необходимо реализовать:**
- Публичная страница записи по поддомену клиники (`{subdomain}.dent-crm.uz/booking`)
- Выбор врача, услуги, даты и времени
- Подтверждение записи через SMS/Telegram
- Виджет для встраивания на сайт клиники

### Модуль 5: Отчёты и экспорт (Приоритет: Средний)

**Текущее состояние:** Есть хук `use-excel-export.tsx`, но ограниченное применение.

**Необходимо реализовать:**
- Отчёт по выручке за период (Excel/PDF)
- Отчёт по врачам (выработка, количество пациентов)
- Отчёт по должникам с контактами
- Отчёт по услугам (популярность, средний чек)
- Акт сверки для пациента (PDF)
- Печать плана лечения

### Модуль 6: Фискализация (Приоритет: Высокий для Узбекистана)

**Текущее состояние:** Поля `fiscal_check_url`, `fiscal_receipt_number`, `is_fiscalized` существуют, но интеграция не реализована.

**Необходимо реализовать:**
- Интеграция с ОФД (MyFin, Soliq, ATOL)
- Автоматическая фискализация чеков
- Печать фискальных чеков

---

## УЛУЧШЕНИЯ UX/UI

### 1. Мобильная адаптация
- Dashboard и расписание не полностью адаптированы под мобильные устройства
- Добавить mobile-first вёрстку для ключевых операций

### 2. Поиск и фильтрация
- Глобальный поиск по пациентам/записям
- Фильтры в таблице платежей (по дате, методу оплаты)
- Фильтры в списке пациентов (по балансу, дате последнего визита)

### 3. Клавиатурные сокращения
- Быстрое создание записи (Ctrl+N)
- Быстрый поиск пациента (Ctrl+K)
- Навигация между разделами

### 4. Темная тема
- Уже настроена через `next-themes`, но требует проверки всех компонентов

---

## ТЕХНИЧЕСКИЕ УЛУЧШЕНИЯ

### 1. Audit Log (системный журнал действий)
**Текущее состояние:** В memory записано требование аудит-лога, но не реализовано.

**Необходимо реализовать:**
- Таблица `audit_logs` для записи всех действий
- Логирование: создание/редактирование пациентов, платежи, изменения записей
- Просмотр логов для администраторов

### 2. Резервное копирование данных
- Автоматический экспорт данных клиники
- Функция "Скачать все мои данные"

### 3. Оптимизация производительности
- Добавить индексы на часто используемые поля (`appointments.start_time`, `patients.clinic_id`)
- Пагинация для больших списков (сейчас `limit(50)` на платежах)
- Кэширование справочников (услуги, категории)

### 4. Тесты
- Покрытие критических функций unit-тестами
- E2E тесты для основных сценариев

---

## АДМИН-ПАНЕЛЬ SUPER ADMIN

**Текущее состояние:** Базовые функции, есть TODO в коде.

**Необходимо реализовать:**
- Функция "Войти как клиника" (impersonation)
- Блокировка/разблокировка клиник
- Управление подписками
- Статистика использования платформы
- Алерты о проблемах (истекающие подписки, жалобы)

---

## РЕКОМЕНДУЕМЫЙ ПОРЯДОК РЕАЛИЗАЦИИ

```text
ФАЗА 1 - Безопасность (1-2 дня):
+--------------------------------------------------+
| 1. Исправить RLS-политики для всех таблиц        |
| 2. Включить защиту от утёкших паролей            |
| 3. Аудит всех edge functions на безопасность     |
+--------------------------------------------------+

ФАЗА 2 - Критический функционал (1 неделя):
+--------------------------------------------------+
| 4. Реальные данные в Analytics                   |
| 5. Интеграция SMS (Eskiz) для уведомлений        |
| 6. Автоматические напоминания о приёмах          |
| 7. Связь склада с услугами                       |
+--------------------------------------------------+

ФАЗА 3 - Бизнес-функции (2 недели):
+--------------------------------------------------+
| 8. Отчёты и экспорт (Excel/PDF)                  |
| 9. Онлайн-запись для пациентов                   |
| 10. Фискализация платежей                        |
| 11. Audit log для действий                       |
+--------------------------------------------------+

ФАЗА 4 - Полировка (1 неделя):
+--------------------------------------------------+
| 12. Мобильная адаптация                          |
| 13. Глобальный поиск                             |
| 14. Админ-функции (impersonation, блокировка)    |
| 15. Тесты и документация                         |
+--------------------------------------------------+
```

---

## Технический раздел

### Секреты, которые нужно настроить:
- `ESKIZ_EMAIL` - email для Eskiz.uz API
- `ESKIZ_PASSWORD` - пароль для Eskiz.uz API  
- `TELEGRAM_BOT_TOKEN` - токен Telegram бота для уведомлений

### Таблицы, которые нужно добавить:
- `audit_logs` - журнал действий пользователей
- `appointment_reminders` - история отправленных напоминаний
- `online_bookings` - заявки на онлайн-запись

### Миграции для RLS:
```sql
-- Пример политики для profiles
CREATE POLICY "Require authentication for profiles" 
ON profiles FOR SELECT 
USING (auth.uid() IS NOT NULL);

-- Аналогично для appointments, payments, performed_works, clinics, user_roles
```

### Edge Functions для добавления:
- `send-appointment-reminder` - автоматические напоминания
- `generate-report` - генерация PDF-отчётов
- `process-online-booking` - обработка онлайн-записей
- `fiscalize-payment` - интеграция с ОФД
